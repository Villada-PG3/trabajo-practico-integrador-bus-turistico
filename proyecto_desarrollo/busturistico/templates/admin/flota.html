{% extends "admin/base_admin.html" %}
{% load app_filters %}
{% block title %}Gestión de Flota - Panel Admin{% endblock %}
{% block content %}
<div class="container-fluid py-3">
    <h1 class="mb-2">Gestión de Flota</h1>
    <p class="mb-4">Administra los buses y sus asignaciones</p>
    <a href="{% url 'admin-nuevo-bus' %}" class="new-btn">+ Nuevo Bus</a>
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5>Total Buses</h5>
                    <span class="badge bg-primary">{{ buses_total.count }}</span>
                </div>
                <div class="d-flex justify-content-around">
                    {% for estado in estados_disponibles %}
                        {% with estado_lower=estado.nombre_estado|lower %}
                            <div><span class="status-badge status-{{ estado_lower|slugify }}">{{ estado.nombre_estado }} {{ estado_counts|get_dict_value:estado_lower }}</span></div>
                        {% endwith %}
                    {% empty %}
                        <div><span class="status-badge">Sin Estado {{ estado_counts|get_dict_value:'sin_estado' }}</span></div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Buscar por patente, unidad o chofer...">
                <button class="btn btn-outline-secondary" type="button">Buscar</button>
            </div>
            <div class="btn-group" role="group">
                <a href="{% url 'admin-flota' %}" class="btn btn-dark {% if not estado_filter %}active{% endif %}">Todos</a>
                {% for estado in estados_disponibles %}
                    {% with estado_lower=estado.nombre_estado|lower %}
                        <a href="{% url 'admin-flota' %}?estado={{ estado_lower }}" class="btn btn-{% if estado_lower == 'activo' %}success{% elif estado_lower == 'reparacion' %}warning{% else %}secondary{% endif %} {% if estado_filter == estado_lower %}active{% endif %}">{{ estado.nombre_estado }}</a>
                    {% endwith %}
                {% empty %}
                    <a href="{% url 'admin-flota' %}?estado=sin_estado" class="btn btn-secondary {% if estado_filter == 'sin_estado' %}active{% endif %}">Sin Estado</a>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="row">
        {% for item in bus_data %}
        <div class="col-md-6 mb-3">
            <div class="card p-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Unidad {{ item.bus.numero_unidad }}</h5>
                        <p>Patente: {{ item.bus.patente_bus }}</p>
                        <p>Compra: {{ item.bus.fecha_compra|date:"d/m/Y" }}</p>
                    </div>
                    <div>
                        <span class="status-badge status-{{ item.estado|lower|slugify }}">
                            {{ item.estado }}
                        </span>
                    </div>
                </div>
                <div class="mt-2 text-end">
                    <a href="{% url 'admin-detalle-bus' item.bus.pk %}" class="btn btn-info btn-sm me-1">Detalle</a>
                    <a href="{% url 'admin-editar-bus' item.bus.pk %}" class="btn btn-primary btn-sm me-1">Editar</a>
                    <a href="{% url 'admin-eliminar-bus' item.bus.pk %}" class="btn btn-danger btn-sm">Eliminar</a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p>No hay buses registrados {% if estado_filter %}para el estado "{{ estado_filter|capfirst }}"{% endif %}.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}