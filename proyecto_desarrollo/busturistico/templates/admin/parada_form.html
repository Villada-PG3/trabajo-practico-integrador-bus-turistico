{% extends "admin/base_admin.html" %}
{% block title %}{% if object %}Editar Parada{% else %}Crear Nueva Parada{% endif %}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4 m-0">{% if object %}Editar Parada{% else %}Crear Nueva Parada{% endif %}</h2>
          </div>

          {% if form.non_field_errors %}
            <div class="alert alert-danger">
              <ul class="mb-0">
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}

            <div class="row g-3">
              <!-- Nombre -->
              <div class="col-md-6">
                <label for="{{ form.nombre_parada.id_for_label }}" class="form-label">Nombre de la parada</label>
                <input
                  type="text"
                  name="{{ form.nombre_parada.name }}"
                  id="{{ form.nombre_parada.id_for_label }}"
                  class="form-control {% if form.nombre_parada.errors %}is-invalid{% endif %}"
                  value="{{ form.nombre_parada.value|default_if_none:'' }}"
                  placeholder="Ej: Plaza de Mayo"
                  required
                />
                {% if form.nombre_parada.errors %}
                  <div class="invalid-feedback d-block">{{ form.nombre_parada.errors|striptags }}</div>
                {% endif %}
              </div>

              <!-- Dirección -->
              <div class="col-md-6">
                <label for="{{ form.direccion_parada.id_for_label }}" class="form-label">Dirección</label>
                <input
                  type="text"
                  name="{{ form.direccion_parada.name }}"
                  id="{{ form.direccion_parada.id_for_label }}"
                  class="form-control {% if form.direccion_parada.errors %}is-invalid{% endif %}"
                  value="{{ form.direccion_parada.value|default_if_none:'' }}"
                  placeholder="Ej: Av. de Mayo 100, CABA"
                  required
                />
                {% if form.direccion_parada.errors %}
                  <div class="invalid-feedback d-block">{{ form.direccion_parada.errors|striptags }}</div>
                {% endif %}
              </div>

              <!-- Descripción -->
              <div class="col-12">
                <label for="{{ form.descripcion_parada.id_for_label }}" class="form-label">Descripción</label>
                <textarea
                  name="{{ form.descripcion_parada.name }}"
                  id="{{ form.descripcion_parada.id_for_label }}"
                  class="form-control {% if form.descripcion_parada.errors %}is-invalid{% endif %}"
                  rows="3"
                  placeholder="Breve descripción de la parada"
                >{{ form.descripcion_parada.value|default_if_none:'' }}</textarea>
                {% if form.descripcion_parada.errors %}
                  <div class="invalid-feedback d-block">{{ form.descripcion_parada.errors|striptags }}</div>
                {% endif %}
              </div>

              <!-- Lat / Lng -->
              <div class="col-md-6">
                <label for="{{ form.latitud_parada.id_for_label }}" class="form-label">Latitud</label>
                <input
                  type="number"
                  step="any"
                  name="{{ form.latitud_parada.name }}"
                  id="{{ form.latitud_parada.id_for_label }}"
                  class="form-control {% if form.latitud_parada.errors %}is-invalid{% endif %}"
                  value="{{ form.latitud_parada.value|default_if_none:'' }}"
                  placeholder="-34.6037"
                  required
                />
                {% if form.latitud_parada.errors %}
                  <div class="invalid-feedback d-block">{{ form.latitud_parada.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                <label for="{{ form.longitud_parada.id_for_label }}" class="form-label">Longitud</label>
                <input
                  type="number"
                  step="any"
                  name="{{ form.longitud_parada.name }}"
                  id="{{ form.longitud_parada.id_for_label }}"
                  class="form-control {% if form.longitud_parada.errors %}is-invalid{% endif %}"
                  value="{{ form.longitud_parada.value|default_if_none:'' }}"
                  placeholder="-58.3816"
                  required
                />
                {% if form.longitud_parada.errors %}
                  <div class="invalid-feedback d-block">{{ form.longitud_parada.errors|striptags }}</div>
                {% endif %}
              </div>

              <!-- Foto -->
              <div class="col-md-6">
                <label for="{{ form.foto_parada.id_for_label }}" class="form-label">Foto (opcional)</label>
                <input
                  type="file"
                  name="{{ form.foto_parada.name }}"
                  id="{{ form.foto_parada.id_for_label }}"
                  class="form-control {% if form.foto_parada.errors %}is-invalid{% endif %}"
                  accept="image/*"
                />
                {% if form.foto_parada.errors %}
                  <div class="invalid-feedback d-block">{{ form.foto_parada.errors|striptags }}</div>
                {% endif %}
                {% if object and object.foto_parada %}
                  <div class="mt-2">
                    <img src="{{ object.foto_parada.url }}" alt="Foto actual" class="img-thumbnail" style="max-height:140px;">
                  </div>
                {% endif %}
              </div>

              <!-- Asignación a recorrido (colapsable) -->
              <div class="col-12">
                <div class="border rounded p-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0">Asignación a Recorrido </h6>
                  </div>
                  <div class="collapse show mt-3" id="boxRecorrido">
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label for="{{ form.recorrido_a_asignar.id_for_label }}" class="form-label">Recorrido</label>
                        <select
                          name="{{ form.recorrido_a_asignar.name }}"
                          id="{{ form.recorrido_a_asignar.id_for_label }}"
                          class="form-select {% if form.recorrido_a_asignar.errors %}is-invalid{% endif %}"
                        >
                          <option value="">No asignar a un recorrido</option>
                          {% with current=form.recorrido_a_asignar.value %}
                            {% for r in form.recorrido_a_asignar.field.queryset %}
                              <option value="{{ r.pk }}" {% if current|stringformat:"s" == r.pk|stringformat:"s" %}selected{% endif %}>
                                {{ r }}
                              </option>
                            {% endfor %}
                          {% endwith %}
                        </select>
                        {% if form.recorrido_a_asignar.errors %}
                          <div class="invalid-feedback d-block">{{ form.recorrido_a_asignar.errors|striptags }}</div>
                        {% endif %}
                        <div class="form-text">Elegí un recorrido si querés insertar la parada en una ruta.</div>
                      </div>

                      <div class="col-md-4">
                        <label for="{{ form.orden_en_recorrido.id_for_label }}" class="form-label">Orden en el recorrido</label>
                        <input
                          type="number"
                          min="1"
                          name="{{ form.orden_en_recorrido.name }}"
                          id="{{ form.orden_en_recorrido.id_for_label }}"
                          class="form-control {% if form.orden_en_recorrido.errors %}is-invalid{% endif %}"
                          value="{{ form.orden_en_recorrido.value|default_if_none:'' }}"
                          placeholder="Ej: 3"
                        />
                        {% if form.orden_en_recorrido.errors %}
                          <div class="invalid-feedback d-block">{{ form.orden_en_recorrido.errors|striptags }}</div>
                        {% endif %}
                        <div class="form-text">Si dejás vacío, la parada se agrega al final del recorrido.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- acciones -->
            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">Guardar</button>
              <a href="{% url 'admin-paradas' %}" class="btn btn-secondary">Cancelar</a>
            </div>
          </form>

          <p class="mt-3 text-muted small">Fecha de referencia: {% now "d/m/Y H:i" %}</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Validación Bootstrap
  (function () {
    'use strict';
    var forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();
</script>
{% endblock %}
