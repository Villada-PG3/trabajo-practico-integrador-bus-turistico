{% extends 'usuario/base_usuario.html' %}
{% block title %}Mapa en Vivo - Bus Turístico{% endblock %}
{% block content %}
<section class="container py-4">
  <h1 class="h3 mb-3"><i class="fas fa-map-marked-alt text-primary me-2"></i>Mapa en Vivo</h1>
  <div class="row g-3">
    <div class="col-12 col-lg-9">
      <div id="map" style="height: 70vh; border-radius: 12px; overflow: hidden; border: 1px solid #eee"></div>
    </div>
    <div class="col-12 col-lg-3">
      <div class="modern-card p-3">
        <h6 class="fw-bold mb-2">Buses Activos</h6>
        <div id="panel-buses" class="small text-muted">Cargando...</div>
        <hr>
        <h6 class="fw-bold mb-2">Ver Paradas por Recorrido</h6>
        <div class="input-group input-group-sm mb-2">
          <input id="recorrido-id" type="number" min="1" class="form-control" placeholder="ID de recorrido">
          <button id="btn-cargar-recorrido" class="btn btn-outline-primary">Cargar</button>
        </div>
        <div class="small text-muted">Traza la ruta ordenando paradas.</div>
      </div>
    </div>
  </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
let map;
let busMarkers = {};
let recorridoLayer = null;

function initMap() {
  // Centro en Ciudad de Buenos Aires (Obelisco aprox.)
  map = L.map('map').setView([-34.6037, -58.3816], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
}

async function fetchJSON(url) {
  const res = await fetch(url, {headers: {'Accept': 'application/json'}});
  if (!res.ok) throw new Error('Error ' + res.status);
  return res.json();
}

function updatePanel(items) {
  const panel = document.getElementById('panel-buses');
  if (!items.length) {
    panel.textContent = 'Sin buses activos.';
    return;
  }
  panel.innerHTML = items.map(it => {
    const eta = it.closest_parada && (it.closest_parada.eta_min !== null) ? `${it.closest_parada.eta_min} min` : 'N/D';
    const parada = it.closest_parada ? it.closest_parada.nombre : 'N/D';
    return `#${it.viaje_id} · ${it.recorrido.color} · ${it.bus.patente}<br><span class="text-muted">Próx. parada: ${parada} · ETA: ${eta}</span>`;
  }).join('<hr class="my-2">');
}

function renderBuses(items) {
  // Actualiza/crea marcadores por viaje
  items.forEach(it => {
    const key = 'viaje_' + it.viaje_id;
    const latlng = [it.ubicacion.lat, it.ubicacion.lng];
    const popup = `<strong>Recorrido:</strong> ${it.recorrido.color}<br>` +
                  `<strong>Bus:</strong> ${it.bus.patente} (U${it.bus.unidad})<br>` +
                  (it.closest_parada ? `<strong>Parada cercana:</strong> ${it.closest_parada.nombre} (ETA ${it.closest_parada.eta_min ?? 'N/D'} min)` : '');
    if (busMarkers[key]) {
      busMarkers[key].setLatLng(latlng).setPopupContent(popup);
    } else {
      busMarkers[key] = L.marker(latlng, {title: it.bus.patente}).addTo(map).bindPopup(popup);
    }
  });
}

async function refreshActive() {
  try {
    const data = await fetchJSON('/api/ubicaciones/activas/');
    updatePanel(data.items);
    renderBuses(data.items);
  } catch (e) {
    // Silencioso para no interrumpir la UI
  }
}

async function loadRecorrido(id) {
  try {
    const data = await fetchJSON(`/api/recorridos/${id}/paradas/`);
    const latlngs = data.paradas.map(p => [p.parada.lat, p.parada.lng]);
    if (recorridoLayer) { map.removeLayer(recorridoLayer); }
    const group = L.layerGroup();
    data.paradas.forEach((p, idx) => {
      L.marker([p.parada.lat, p.parada.lng]).addTo(group)
        .bindPopup(`#${p.orden} · ${p.parada.nombre}<br>${p.parada.direccion}`);
    });
    const line = L.polyline(latlngs, {color: '#007bff'}).addTo(group);
    group.addTo(map);
    recorridoLayer = group;
    if (latlngs.length) {
      map.fitBounds(line.getBounds(), {padding: [20, 20]});
    }
  } catch (e) {
    alert('No se pudo cargar el recorrido.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();
  refreshActive();
  setInterval(refreshActive, 10000); // 10s

  document.getElementById('btn-cargar-recorrido').addEventListener('click', () => {
    const id = document.getElementById('recorrido-id').value;
    if (id) loadRecorrido(id);
  });
});
</script>

<style>
.modern-card { background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
</style>
{% endblock %}
